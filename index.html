<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
        }

        .header {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .refresh-status {
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .refresh-status span {
            margin-left: 10px;
        }

        .container {
            padding: 20px;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
            color: #555;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            min-width: 150px;
        }

        #jobs-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .job-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid;
            display: flex;
            flex-direction: column;
        }

        .job-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .job-ref {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }

        .job-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        
        /* Status Colors */
        .new { background-color: #007bff; border-color: #007bff; }
        .in-progress { background-color: #ffc107; border-color: #ffc107; color: #333; }
        .on-hold { background-color: #6c757d; border-color: #6c757d; }
        .complete { background-color: #28a745; border-color: #28a745; }
        .cancelled { background-color: #dc3545; border-color: #dc3545; }

        /* Job Card Border Colors */
        .job-card.new { border-left-color: #007bff; }
        .job-card.in-progress { border-left-color: #ffc107; }
        .job-card.on-hold { border-left-color: #6c757d; }
        .job-card.complete { border-left-color: #28a745; }
        .job-card.cancelled { border-left-color: #dc3545; }


        .job-details p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .job-details strong {
            display: inline-block;
            width: 70px;
            font-weight: 600;
            color: #555;
        }

        .no-jobs {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6c757d;
        }

        /* Status Menu (Context Menu) */
        #statusMenu {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            min-width: 150px;
            padding: 5px 0;
        }

        .menu-heading {
            font-weight: bold;
            padding: 5px 15px;
            font-size: 0.8em;
            color: #6c757d;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
        }

        .status-option {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.95em;
        }

        .status-option:hover {
            background-color: #f1f1f1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .modal-content select,
        .modal-content input[type="date"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-content button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .modal-content button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Job Scheduling Dashboard</h1>
        <div class="refresh-status">
            <span id="loading-indicator" style="display:none;">Loading...</span>
            <span id="refresh-countdown">Refreshing in 30s</span>
        </div>
    </div>

    <div class="container">
        <div class="filters">
            <div class="filter-group">
                <label for="engineerFilter">Filter by Engineer:</label>
                <select id="engineerFilter">
                    </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Filter by Date:</label>
                <input type="date" id="dateFilter">
            </div>
            <div class="filter-group">
                <button id="clearFiltersBtn">Clear Filters</button>
            </div>
        </div>

        <div id="jobs-container">
            <div id="loading-jobs-message" class="no-jobs">
                Loading job data...
            </div>
        </div>
    </div>

    <div id="statusMenu">
        <div class="menu-heading">Update Status</div>
        <div class="status-option" data-action="status" data-status="New">New</div>
        <div class="status-option" data-action="status" data-status="In Progress">In Progress</div>
        <div class="status-option" data-action="status" data-status="On Hold">On Hold</div>
        <div class="status-option" data-action="status" data-status="Complete">Complete</div>
        <div class="status-option" data-action="status" data-status="Cancelled">Cancelled</div>
        <div class="menu-heading" style="margin-top: 5px;">Update Other Fields</div>
        <div class="status-option" data-action="engineer">Change Engineer (Column O)</div>
        <div class="status-option" data-action="date">Change Date (Columns J, K, L)</div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Update Job</h2>

            <div id="engineerField">
                <label for="modalEngineerSelect">Select New Engineer:</label>
                <select id="modalEngineerSelect"></select>
            </div>

            <div id="dateField" style="display:none;">
                <label for="modalDateInput">Select New Date:</label>
                <input type="date" id="modalDateInput">
            </div>

            <button onclick="saveChanges()">Save Changes</button>
        </div>
    </div>

    <script>
        // REPLACE THIS WITH YOUR ACTUAL GOOGLE APPS SCRIPT URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbzt_YC8oU_y_8jQJBeVNoWGBIZljQrn6YicBZGhJ0Hcrvt7k264RVZjYb8DnPNeFrT_/exec';
        
        let allJobs = [];
        let allEngineers = [];
        let selectedDate = '';
        let selectedEngineer = '';
        let currentJobCard = null;
        let currentJobRef = null;
        let refreshInterval = null;
        let countdownInterval = null;
        let secondsUntilRefresh = 30;
        const REFRESH_INTERVAL_MS = 30000; // 30 seconds

        const jobsContainer = document.getElementById('jobs-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const refreshCountdown = document.getElementById('refresh-countdown');
        const engineerFilter = document.getElementById('engineerFilter');
        const dateFilter = document.getElementById('dateFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const loadingJobsMessage = document.getElementById('loading-jobs-message');

        const updateModal = document.getElementById('updateModal');
        const modalTitle = document.getElementById('modalTitle');
        const engineerField = document.getElementById('engineerField');
        const dateField = document.getElementById('dateField');
        const modalEngineerSelect = document.getElementById('modalEngineerSelect');
        const modalDateInput = document.getElementById('modalDateInput');

        // --- Core Functions ---

        function init() {
            setupEventListeners();
            loadJobs();
            startAutoRefresh();
        }

        function setupEventListeners() {
            engineerFilter.addEventListener('change', handleEngineerChange);
            dateFilter.addEventListener('change', handleDateChange);
            clearFiltersBtn.addEventListener('click', clearFilters);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.job-card') && !e.target.closest('#statusMenu')) {
                    document.getElementById('statusMenu').style.display = 'none';
                    currentJobCard = null;
                    currentJobRef = null;
                }
            });
            window.onclick = function(event) {
                if (event.target == updateModal) {
                    closeModal();
                }
            }
        }

        function startAutoRefresh() {
            clearInterval(refreshInterval);
            clearInterval(countdownInterval);
            
            // Countdown timer
            countdownInterval = setInterval(() => {
                secondsUntilRefresh--;
                refreshCountdown.textContent = `Refreshing in ${secondsUntilRefresh}s`;
                if (secondsUntilRefresh <= 0) {
                    secondsUntilRefresh = 30;
                }
            }, 1000);

            // Full refresh interval
            refreshInterval = setInterval(() => {
                loadJobs(true);
            }, REFRESH_INTERVAL_MS);
        }
        
        async function loadJobs(isAutoRefresh = false) {
            if (!isAutoRefresh) {
                loadingJobsMessage.style.display = 'block';
                jobsContainer.innerHTML = '';
            }
            loadingIndicator.style.display = 'inline';
            refreshCountdown.style.display = 'none';

            try {
                const response = await fetch(API_URL + '?action=getJobs');
                const result = await response.json();

                if (result.success && Array.isArray(result.data)) {
                    allJobs = result.data.map(job => {
                        // Ensure required fields exist and format date/status
                        const [day, month, year] = (job.DisplayDate || '1/1/2000').split('/');
                        const status = job.Status || 'New';
                        
                        return {
                            ...job,
                            // Store date parts for filtering/sorting
                            dateComponents: { day: Number(day), month: Number(month), year: Number(year) },
                            // Ensure status is lowercased and dashed for class names
                            statusClass: status.toLowerCase().replace(' ', '-'),
                            Status: status
                        };
                    });
                    
                    const uniqueEngineers = [...new Set(allJobs.map(job => job.Engineer).filter(e => e))].sort();
                    allEngineers = uniqueEngineers;

                    populateEngineersFilter();
                    populateEngineersListAndFilterJobs();
                    secondsUntilRefresh = 30; // Reset countdown
                } else {
                    jobsContainer.innerHTML = `<div class="no-jobs">Error loading data: ${result.message || 'Invalid response format'}</div>`;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                jobsContainer.innerHTML = `<div class="no-jobs">Failed to connect to the API.</div>`;
            } finally {
                loadingIndicator.style.display = 'none';
                refreshCountdown.style.display = 'inline';
                loadingJobsMessage.style.display = 'none';
            }
        }

        // --- Filtering Functions ---

        function populateEngineersFilter() {
            engineerFilter.innerHTML = '<option value="">All Engineers</option>';
            allEngineers.forEach(engineer => {
                const option = document.createElement('option');
                option.value = engineer;
                option.textContent = engineer;
                if (engineer === selectedEngineer) {
                    option.selected = true;
                }
                engineerFilter.appendChild(option);
            });
        }

        function populateEngineersListAndFilterJobs() {
            // This function is the main entry point to re-render the cards
            filterJobs();
        }

        function handleEngineerChange(e) {
            selectedEngineer = e.target.value;
            filterJobs();
        }

        function handleDateChange(e) {
            selectedDate = e.target.value; // YYYY-MM-DD format
            filterJobs();
        }
        
        function clearFilters() {
            selectedEngineer = '';
            selectedDate = '';
            engineerFilter.value = '';
            dateFilter.value = '';
            filterJobs();
        }

        function filterJobs() {
            let filteredJobs = allJobs;

            if (selectedEngineer) {
                filteredJobs = filteredJobs.filter(job => job.Engineer === selectedEngineer);
            }

            if (selectedDate) {
                // Parse selected date into YYYY-MM-DD format for easy comparison
                const [year, month, day] = selectedDate.split('-');
                const selectedDateString = `${Number(day)}/${Number(month)}/${Number(year)}`;

                filteredJobs = filteredJobs.filter(job => {
                    // Assuming job.DisplayDate is 'D/M/YYYY' from the script,
                    // or a similar format we can compare.
                    // The job.displayDate is set to D/M/YYYY in loadJobs if missing.
                    return job.DisplayDate === selectedDateString;
                });
            }

            displayJobs(filteredJobs);
        }

        // --- Display Functions ---

        function displayJobs(jobs) {
            jobsContainer.innerHTML = '';

            if (jobs.length === 0) {
                jobsContainer.innerHTML = '<div class="no-jobs">No jobs found matching the current filters.</div>';
                return;
            }

            // Sort by date (Year, then Month, then Day)
            jobs.sort((a, b) => {
                if (a.dateComponents.year !== b.dateComponents.year) return a.dateComponents.year - b.dateComponents.year;
                if (a.dateComponents.month !== b.dateComponents.month) return a.dateComponents.month - b.dateComponents.month;
                return a.dateComponents.day - b.dateComponents.day;
            });

            jobs.forEach(job => {
                const card = createJobCard(job);
                jobsContainer.appendChild(card);
            });
        }

        function createJobCard(job) {
            const card = document.createElement('div');
            card.className = `job-card ${job.statusClass}`;
            card.dataset.ref = job.Ref;
            card.onclick = handleJobCardClick;

            const header = document.createElement('div');
            header.className = 'job-header';
            header.innerHTML = `
                <span class="job-ref">#${job.Ref}</span>
                <span class="job-status ${job.statusClass}">${job.Status}</span>
            `;

            const details = document.createElement('div');
            details.className = 'job-details';
            details.innerHTML = `
                <p><strong>Engineer:</strong> ${job.Engineer || 'Unassigned'}</p>
                <p><strong>Date:</strong> ${job.DisplayDate}</p>
                <p><strong>Description:</strong> ${job.Description || 'N/A'}</p>
            `;

            card.appendChild(header);
            card.appendChild(details);

            return card;
        }

        // --- Modal/Context Menu Functions ---

        function handleJobCardClick(e) {
            e.stopPropagation();
            currentJobCard = e.currentTarget;
            currentJobRef = currentJobCard.dataset.ref;
            
            const rect = currentJobCard.getBoundingClientRect();
            const statusMenu = document.getElementById('statusMenu');
            
            statusMenu.style.display = 'block';
            statusMenu.style.left = rect.left + 'px';
            statusMenu.style.top = (rect.bottom + 5) + 'px';
            
            statusMenu.querySelectorAll('.status-option').forEach(option => {
                option.onclick = () => handleMenuOptionClick(option);
            });
        }

        function handleMenuOptionClick(option) {
            const action = option.dataset.action;
            const statusMenu = document.getElementById('statusMenu');
            statusMenu.style.display = 'none';

            if (!currentJobRef) return;

            if (action === 'status') {
                // Direct call for status update (Only updates Status column)
                updateJobStatus(option.dataset.status); 
            } else if (action === 'engineer') {
                openModal('engineer');
            } else if (action === 'date') {
                openModal('date');
            }
        }

        function openModal(type) {
            const job = allJobs.find(j => j.Ref == currentJobRef);
            if (!job) return;

            modalTitle.textContent = `Update Job #${currentJobRef}`;
            updateModal.dataset.updateType = type;

            if (type === 'engineer') {
                engineerField.style.display = 'block';
                dateField.style.display = 'none';
                populateModalEngineerSelect(job.Engineer);
            } else if (type === 'date') {
                engineerField.style.display = 'none';
                dateField.style.display = 'block';
                
                // Format date components to YYYY-MM-DD for the input field
                const formattedMonth = String(job.dateComponents.month).padStart(2, '0');
                const formattedDay = String(job.dateComponents.day).padStart(2, '0');
                const dateString = `${job.dateComponents.year}-${formattedMonth}-${formattedDay}`;
                modalDateInput.value = dateString;
            }

            updateModal.style.display = 'block';
        }

        function closeModal() {
            updateModal.style.display = 'none';
            currentJobCard = null;
            currentJobRef = null;
        }

        function populateModalEngineerSelect(currentEngineer) {
            modalEngineerSelect.innerHTML = '';
            
            const unassignedOption = document.createElement('option');
            unassignedOption.value = '';
            unassignedOption.textContent = 'Unassigned';
            modalEngineerSelect.appendChild(unassignedOption);

            allEngineers.forEach(engineer => {
                const option = document.createElement('option');
                option.value = engineer;
                option.textContent = engineer;
                if (engineer === currentEngineer) {
                    option.selected = true;
                }
                modalEngineerSelect.appendChild(option);
            });
        }
        
        async function saveChanges() {
            const type = updateModal.dataset.updateType;
            let dataToUpdate = {};
            const jobRef = currentJobRef;

            if (type === 'engineer') {
                const newEngineer = modalEngineerSelect.value || '';
                
                // Maps to API column name "Engineer" (Column O)
                dataToUpdate['Engineer'] = newEngineer; 
                dataToUpdate['clientField'] = 'Engineer'; // For client-side data update
            } else if (type === 'date') {
                const newDateValue = modalDateInput.value;
                
                if (!newDateValue) {
                    alert('Please select a date.');
                    return;
                }

                // Map to API column names "Day", "Month", "Year" (Columns J, K, L)
                const parts = newDateValue.split('-'); // YYYY-MM-DD
                dataToUpdate['Year'] = parts[0];
                dataToUpdate['Month'] = parts[1];
                dataToUpdate['Day'] = parts[2];
                dataToUpdate['clientField'] = 'Date'; // For client-side data update
            } else {
                return;
            }

            closeModal(); 
            
            // Pass the job reference and the object containing all necessary updates
            await updateJobData(jobRef, dataToUpdate);
        }

        /**
         * Generic function to update multiple job fields (Engineer or Date).
         * The payload contains only the column(s) that need to be updated.
         * @param {string} jobRef The job reference.
         * @param {object} updates Contains the field(s) to update and client-side helpers.
         */
        async function updateJobData(jobRef, updates) {
            const clientField = updates.clientField;
            const payload = {
                action: "updateJob",
                data: {
                    Ref: jobRef
                }
            };

            // Copy all update fields (like Engineer or Day/Month/Year) to the payload
            for (const key in updates) {
                if (key !== 'clientField') { // Don't send client-side helpers to the API
                    payload.data[key] = updates[key];
                }
            }

            try {
                console.log(`Updating job ${jobRef} with:`, payload.data);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const job = allJobs.find(j => j.Ref == jobRef);
                    if (job) {
                        if (clientField === 'Date') {
                            // Update client-side job object properties
                            const day = Number(updates.Day);
                            const month = Number(updates.Month);
                            const year = Number(updates.Year);
                            
                            job.Day = day;
                            job.Month = month;
                            job.Year = year;
                            job.dateComponents = { day, month, year };
                            job.DisplayDate = `${day}/${month}/${year}`;
                        } else if (clientField === 'Engineer') {
                            job.Engineer = updates.Engineer;
                        }
                    }
                    
                    // Re-render the dashboard to reflect the change
                    populateEngineersListAndFilterJobs();
                    console.log(`Job ${jobRef} updated successfully.`);
                } else {
                    throw new Error(result.message || 'Unknown error occurred');
                }
            } catch (error) {
                console.error(`Error updating job data:`, error);
                alert(`Failed to update job data: ${error.message}. Please check your Google Apps Script.`);
                await loadJobs(true); // Re-load jobs in case of failure to sync client data
            }
        }
        
        /**
         * Function dedicated ONLY to updating the Status column.
         * @param {string} newStatus The new status value.
         */
        async function updateJobStatus(newStatus) {
            const jobRef = currentJobRef;
            const payload = {
                action: "updateJob",
                data: {
                    Ref: jobRef,
                    Status: newStatus // Only send Status
                }
            };

            try {
                console.log(`Updating job ${jobRef} to status: ${newStatus}`);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const job = allJobs.find(j => j.Ref == jobRef);
                    const statusClass = newStatus.toLowerCase().replace(' ', '-');

                    if (job) {
                        job.Status = newStatus;
                        job.statusClass = statusClass;
                    }
                    
                    // Update card display directly for quick visual feedback
                    if (currentJobCard) {
                        currentJobCard.className = 'job-card ' + statusClass;
                        currentJobCard.querySelector('.job-status').textContent = newStatus;
                        currentJobCard.querySelector('.job-status').className = 'job-status ' + statusClass;
                    }

                    // Re-render the dashboard (or just filter) as status might affect display
                    populateEngineersListAndFilterJobs(); 
                    console.log('Job status updated successfully');
                } else {
                    throw new Error(result.message || 'Unknown error occurred');
                }
            } catch (error) {
                console.error('Error updating job status:', error);
                alert(`Failed to update job status: ${error.message}.`);
                await loadJobs(true);
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
