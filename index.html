<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Scheduling Dashboard</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .header-logo {
            height: 60px;
            width: auto;
            border-radius: 50%;
        }

        .header h1 {
            text-align: center;
            font-size: 2em;
            margin: 0;
        }

        .filters {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
        }

        select, input[type="date"] {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 16px;
            min-width: 150px;
        }

        .add-appointment-btn, .add-engineer-btn, #assignJobsBtn, #mapViewBtn {
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
        }

        .add-appointment-btn {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }

        .add-engineer-btn {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
        }

        #assignJobsBtn {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            box-shadow: 0 4px 10px rgba(253, 121, 168, 0.3);
        }

        #mapViewBtn {
            background: linear-gradient(135deg, #0984e3 0%, #00b894 100%);
            box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3);
        }

        .add-appointment-btn:hover, .add-engineer-btn:hover, #assignJobsBtn:hover, #mapViewBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 184, 148, 0.4);
        }

        #assignJobsBtn:hover {
            box-shadow: 0 6px 15px rgba(253, 121, 168, 0.4);
        }

        #mapViewBtn:hover {
            box-shadow: 0 6px 15px rgba(9, 132, 227, 0.4);
        }

        #assignJobsBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .refresh-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .refresh-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .refresh-toggle label {
            cursor: pointer;
            margin: 0;
            color: #333;
        }

        .refresh-status {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: calc(100vh - 140px);
        }

        .engineers-sidebar {
            width: 200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            height: fit-content;
        }

        .engineers-sidebar h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.2em;
        }

        .engineer-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .engineer-item:hover {
            background: #e8ecff;
            transform: translateX(5px);
        }

        .engineer-item.selected {
            background: #667eea;
            color: white;
        }
        
        .jobs-area {
            flex: 1;
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }
        
        .engineer-column {
            min-width: 450px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .engineer-column h3 {
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            margin: 0;
            font-size: 1.1em;
            text-align: center;
        }
        
        .engineer-job-sections {
            display: flex;
            flex-grow: 1;
        }
        
        .time-section {
            flex: 1;
            padding: 15px;
        }

        .time-section h4 {
            color: #636e72;
            text-align: center;
            margin-bottom: 10px;
        }

        .jobs-container {
            flex-grow: 1;
        }

        .job-card {
            background: white;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .job-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .job-card.on-route {
            border-color: #fdcb6e;
            background: linear-gradient(135deg, #fff9e6 0%, #fef5d3 100%);
        }

        .job-card.in-progress {
            border-color: #74b9ff;
            background: linear-gradient(135deg, #e6f3ff 0%, #d1ecff 100%);
        }

        .job-card.completed {
            border-color: #00b894;
            background: linear-gradient(135deg, #e6fff9 0%, #d1ffed 100%);
        }

        .job-card.cancelled {
            border-color: #636e72;
            background: linear-gradient(135deg, #f1f2f6 0%, #e8eaed 100%);
        }

        .job-card.aborted {
            border-color: #e84393;
            background: linear-gradient(135deg, #ffe6f1 0%, #ffd3e8 100%);
        }

        .job-card.unassigned {
            border-color: #ff7675;
            background: linear-gradient(135deg, #ffecec 0%, #ffdada 100%);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .job-ref {
            font-weight: bold;
            font-size: 1.1em;
            color: #2d3436;
        }

        .job-status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .job-status.on-route { background: #fdcb6e; color: #2d3436; }
        .job-status.in-progress { background: #74b9ff; color: white; }
        .job-status.completed { background: #00b894; color: white; }
        .job-status.cancelled { background: #636e72; color: white; }
        .job-status.aborted { background: #e84393; color: white; }
        .job-status.unassigned { background: #ff7675; color: white; }

        .job-details {
            margin-bottom: 10px;
        }

        .job-detail {
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .job-detail strong {
            color: #2d3436;
        }

        .status-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            padding: 10px;
            z-index: 1000;
            border: 1px solid #e0e6ed;
            min-width: 200px; 
        }

        .menu-divider {
            height: 1px;
            background-color: #e0e6ed;
            margin: 5px 0;
        }

        .status-option {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background 0.2s ease;
            font-size: 0.9em;
        }

        .status-option:hover {
            background: #f8f9ff;
        }

        .status-option:last-child {
            margin-bottom: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
            color: #636e72;
        }

        .no-jobs {
            text-align: center;
            padding: 40px;
            color: #636e72;
            font-style: italic;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refreshing {
            animation: pulse 1s ease-in-out;
        }

        .modal {
            display: none;
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            color: #667eea;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-content input[type="date"],
        .modal-content select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: none;
            box-sizing: border-box;
        }

        .modal-content button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            float: right;
        }

        .modal-content button:hover {
            background: #5a6ed0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3436;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-buttons button {
            float: none;
        }

        .cancel-btn {
            background: #636e72;
        }

        .cancel-btn:hover {
            background: #4a5256;
        }

        #unassignedJobsList {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        #unassignedJobsList .job-card {
            margin-bottom: 20px;
        }

        #unassignedJobsList select {
            margin-top: 10px;
            width: 100%;
        }

        /* ==== MAP MODAL ==== */
        #mapModal .modal-content {
            max-width: 95%;
            width: 1100px;
            padding: 15px;
        }

        #mapFilterBar {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        #mapFilterBar label {
            font-weight: 600;
            color: #2d3436;
        }

        #mapFilterBar select,
        #mapFilterBar input {
            min-width: 200px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        #mapContainer {
            height: 600px;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .header-logo {
                height: 40px;
            }
            
            .main-content {
                flex-direction: column;
                padding: 10px;
            }
            
            .engineers-sidebar {
                width: 100%;
                order: 2;
            }
            
            .jobs-area {
                flex-direction: column;
            }

            #mapModal .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            #mapContainer {
                height: 400px;
            }

            #mapFilterBar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <img src="https://www.dropbox.com/scl/fi/4eilt1ka4obatkaif4ksg/Screenshot-2025-06-11-132304.png?rlkey=1puz3m5i205n2t4q9n6srfq56&st=00ujjvmz&dl=1" alt="Company Screenshot" class="header-logo">
            <h1>Job Scheduling Dashboard</h1>
            <img src="https://www.dropbox.com/scl/fi/67vmxu3kngvgkm1mf5tcp/Stark.jpg?rlkey=5gz9fhspn3t1aiu03ksob3r2c&st=8ppqfpwr&dl=1" alt="Stark Logo" class="header-logo">
        </div>
        <div class="filters">
            <div class="filter-group">
                <button class="add-appointment-btn" onclick="openAddAppointmentModal()">Add Appointment</button>
            </div>
            <div class="filter-group">
                <button class="add-engineer-btn" onclick="openAddEngineerModal()">Add New Engineer</button>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Select Date:</label>
                <input type="date" id="dateFilter">
            </div>
            <div class="filter-group">
                <label for="engineerFilter">Select Engineer:</label>
                <select id="engineerFilter">
                    <option value="">All Engineers</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="refresh-control">
                    <div class="refresh-toggle">
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        <label for="autoRefreshToggle">Auto-Refresh (30s)</label>
                    </div>
                    <div class="refresh-status" id="refreshStatus">Next refresh in 30s</div>
                </div>
            </div>
            <div class="filter-group">
                <button id="assignJobsBtn">Assign Jobs (0)</button>
            </div>
            <!-- MAP VIEW BUTTON -->
            <div class="filter-group">
                <button id="mapViewBtn">Map View</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="engineers-sidebar">
            <h3>Working Today</h3>
            <div id="engineersList"></div>
        </div>

        <div class="jobs-area" id="engineerJobsContainer">
            <div class="loading">Loading jobs...</div>
        </div>
    </div>

    <!-- Status Menu -->
    <div id="statusMenu" class="status-menu" style="display: none;">
        <div class="status-option" data-action="status" data-status="On Route">Change Status: On Route</div>
        <div class="status-option" data-action="status" data-status="In Progress">Change Status: In Progress</div>
        <div class="status-option" data-action="status" data-status="Completed">Change Status: Completed</div>
        <div class="status-option" data-action="status" data-status="Cancelled">Change Status: Cancelled</div>
        <div class="status-option" data-action="status" data-status="Aborted">Change Status: Aborted</div>
        <div class="menu-divider"></div>
        <div class="status-option" data-action="engineer">Change Engineer</div>
        <div class="status-option" data-action="date">Change Date</div>
    </div>

    <!-- Update Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Update Job #</h2>
            <div id="engineerField">
                <label for="modalEngineerSelect">Select New Engineer:</label>
                <select id="modalEngineerSelect"></select>
            </div>
            <div id="dateField" style="display:none;">
                <label for="modalDateInput">Select New Date:</label>
                <input type="date" id="modalDateInput">
            </div>
            <button onclick="saveChanges()">Save Changes</button>
        </div>
    </div>

    <!-- Add Appointment Modal -->
    <div id="addAppointmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" onclick="closeAddAppointmentModal()">&times;</span>
            <h2>Add New Appointment</h2>
            
            <form id="addAppointmentForm" onsubmit="return false;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="newContactName">Contact Name *</label>
                        <input type="text" id="newContactName" required>
                    </div>
                    <div class="form-group">
                        <label for="newContactNumber">Contact Number *</label>
                        <input type="tel" id="newContactNumber" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newContactEmail">Contact Email</label>
                        <input type="email" id="newContactEmail">
                    </div>
                    <div class="form-group">
                        <label for="newSite">Site</label>
                        <input type="text" id="newSite">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="newAddress">Address *</label>
                        <input type="text" id="newAddress" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newPostcode">Postcode *</label>
                        <input type="text" id="newPostcode" required>
                    </div>
                    <div class="form-group">
                        <label for="newDate">Date *</label>
                        <input type="date" id="newDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newTime">Time *</label>
                        <select id="newTime" required>
                            <option value="">Select Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newEngineer">Engineer *</label>
                        <select id="newEngineer" required>
                            <option value="">Select Engineer</option>
                        </select>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddAppointmentModal()">Cancel</button>
                    <button type="button" onclick="submitNewAppointment()">Add Appointment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Engineer Modal -->
    <div id="addEngineerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" onclick="closeAddEngineerModal()">&times;</span>
            <h2>Add New Engineer</h2>
            
            <form id="addEngineerForm" onsubmit="return false;">
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="engineerName">Name *</label>
                        <input type="text" id="engineerName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="engineerPassword">Password *</label>
                        <input type="password" id="engineerPassword" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="engineerPhone">Engineer Phone Number *</label>
                        <input type="tel" id="engineerPhone" required placeholder="+44 or 07xxx">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="engineerLocation">Location *</label>
                        <select id="engineerLocation" required>
                            <option value="">Select Location</option>
                            <option value="North East">North East</option>
                            <option value="North West">North West</option>
                            <option value="Midlands">Midlands</option>
                            <option value="Eastern">Eastern</option>
                            <option value="South East">South East</option>
                            <option value="South West">South West</option>
                            <option value="London">London</option>
                            <option value="Wales">Wales</option>
                        </select>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddEngineerModal()">Cancel</button>
                    <button type="button" onclick="submitNewEngineer()">Add Engineer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Jobs Modal -->
    <div id="assignJobsModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <span class="close-button" onclick="closeAssignJobsModal()">&times;</span>
            <h2>Assign Jobs</h2>
            <div id="unassignedJobsList"></div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeAssignJobsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- MAP MODAL -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeMapModal()">&times;</span>
            <h2>Engineer Route Map</h2>

            <div id="mapFilterBar">
                <div class="form-group">
                    <label for="mapEngineerSelect">Engineer:</label>
                    <select id="mapEngineerSelect">
                        <option value="">-- All Engineers --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mapDateSelect">Date:</label>
                    <input type="date" id="mapDateSelect">
                </div>
                <button id="refreshMapBtn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Refresh Map</button>
            </div>

            <div id="mapContainer"></div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeMapModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwrRU5wD-emjMH95k8R1m9eiAf48sI0_GyPs6iBRAspeCAxcIjn9McfaUi-JppMIRq1/exec';

let allJobs = [];
let allEngineers = [];
let selectedDate = '';
let selectedEngineer = '';
let currentJobCard = null;
let currentJobRef = null;
let refreshInterval = null;
let countdownInterval = null;
let secondsUntilRefresh = 30;
const REFRESH_INTERVAL_MS = 30000;

// Map globals
let map = null;
let mapMarkers = [];
let mapPolyline = null;

const updateModal = document.getElementById('updateModal');
const modalTitle = document.getElementById('modalTitle');
const engineerField = document.getElementById('engineerField');
const dateField = document.getElementById('dateField');
const modalEngineerSelect = document.getElementById('modalEngineerSelect');
const modalDateInput = document.getElementById('modalDateInput');
const addAppointmentModal = document.getElementById('addAppointmentModal');
const addEngineerModal = document.getElementById('addEngineerModal');
const assignJobsModal = document.getElementById('assignJobsModal');

async function init() {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    document.getElementById('dateFilter').value = todayString;
    document.getElementById('mapDateSelect').value = todayString;
    
    selectedDate = {
        day: today.getDate(),
        month: today.getMonth() + 1,
        year: today.getFullYear()
    };
    
    await loadJobs();
    setupEventListeners();
    startAutoRefresh();

    // Map button
    document.getElementById('mapViewBtn').addEventListener('click', openMapModal);
}

function setupEventListeners() {
    document.getElementById('dateFilter').addEventListener('change', handleDateChange);
    document.getElementById('engineerFilter').addEventListener('change', handleEngineerChange);
    document.getElementById('autoRefreshToggle').addEventListener('change', handleAutoRefreshToggle);
    document.getElementById('assignJobsBtn').addEventListener('click', openAssignJobsModal);
    document.getElementById('refreshMapBtn').addEventListener('click', updateMapView);
    
    document.addEventListener('click', (e) => {
        const statusMenu = document.getElementById('statusMenu');
        if (!statusMenu.contains(e.target) && !e.target.closest('.job-card')) {
            statusMenu.style.display = 'none';
        }
    });
    
    window.onclick = function(event) {
        if (event.target == updateModal) closeModal();
        if (event.target == addAppointmentModal) closeAddAppointmentModal();
        if (event.target == addEngineerModal) closeAddEngineerModal();
        if (event.target == assignJobsModal) closeAssignJobsModal();
        if (event.target == document.getElementById('mapModal')) closeMapModal();
    }
}

function startAutoRefresh() {
    const autoRefreshEnabled = document.getElementById('autoRefreshToggle').checked;
    
    if (autoRefreshEnabled) {
        secondsUntilRefresh = 30;
        updateRefreshStatus();
        
        refreshInterval = setInterval(async () => {
            await refreshJobs();
            secondsUntilRefresh = 30;
        }, REFRESH_INTERVAL_MS);
        
        countdownInterval = setInterval(() => {
            secondsUntilRefresh--;
            updateRefreshStatus();
            if (secondsUntilRefresh <= 0) secondsUntilRefresh = 30;
        }, 1000);
    } else {
        stopAutoRefresh();
    }
}

function stopAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    if (countdownInterval) clearInterval(countdownInterval);
    document.getElementById('refreshStatus').textContent = 'Auto-refresh disabled';
}

function updateRefreshStatus() {
    document.getElementById('refreshStatus').textContent = `Next refresh in ${secondsUntilRefresh}s`;
}

function handleAutoRefreshToggle(e) {
    e.target.checked ? startAutoRefresh() : stopAutoRefresh();
}

async function refreshJobs() {
    const container = document.getElementById('engineerJobsContainer');
    container.classList.add('refreshing');
    try {
        await loadJobs(true);
    } catch (error) {
        console.error('Error refreshing jobs:', error);
    } finally {
        setTimeout(() => container.classList.remove('refreshing'), 300);
    }
}

async function loadJobs(isRefresh = false) {
    try {
        const response = await fetch(`${API_URL}?action=getJobs`);
        const rawJobs = await response.json();
        
        allJobs = rawJobs.map(job => {
            const day = parseInt(job.Day) || 0;
            const month = parseInt(job.Month) || 0;
            const year = parseInt(job.Year) || 0;
            return {
                ...job,
                dateComponents: { day, month, year },
                displayDate: day && month && year ? `${day}/${month}/${year}` : 'No date'
            };
        });
        
        allEngineers = [...new Set(allJobs.map(job => job.Engineer).filter(Boolean))].sort();

        if (!isRefresh) console.log('Loaded jobs:', allJobs.length);
        
        populateEngineersFilter();
        populateEngineersListAndFilterJobs();
        updateAssignJobsButton();
        populateMapEngineerSelect(); // <-- Added
    } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('engineerJobsContainer').innerHTML = '<div class="no-jobs">Error loading jobs. Please check your API URL.</div>';
    }
}

function populateEngineersFilter() {
    const engineerFilter = document.getElementById('engineerFilter');
    const currentValue = engineerFilter.value;
    
    engineerFilter.innerHTML = '<option value="">All Engineers</option>';
    allEngineers.forEach(engineer => {
        const option = document.createElement('option');
        option.value = engineer;
        option.textContent = engineer;
        engineerFilter.appendChild(option);
    });
    engineerFilter.value = currentValue;
    populateNewEngineerSelect();
}

function populateNewEngineerSelect() {
    const newEngineerSelect = document.getElementById('newEngineer');
    const currentValue = newEngineerSelect.value;
    
    newEngineerSelect.innerHTML = '<option value="">Select Engineer</option>';
    allEngineers.forEach(engineer => {
        const option = document.createElement('option');
        option.value = engineer;
        option.textContent = engineer;
        newEngineerSelect.appendChild(option);
    });
    newEngineerSelect.value = currentValue;
}

function populateMapEngineerSelect() {
    const sel = document.getElementById('mapEngineerSelect');
    sel.innerHTML = '<option value="">-- All Engineers --</option>';
    allEngineers.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e;
        opt.textContent = e;
        sel.appendChild(opt);
    });
}

function populateEngineersListAndFilterJobs() {
    const filteredJobs = filterJobs();
    const jobsByEngineer = filteredJobs.reduce((acc, job) => {
        const engineer = job.Engineer || 'Unassigned';
        if (!acc.has(engineer)) acc.set(engineer, []);
        acc.get(engineer).push(job);
        return acc;
    }, new Map());
    
    const workingEngineers = [...jobsByEngineer.keys()].sort();
    
    const engineersList = document.getElementById('engineersList');
    engineersList.innerHTML = workingEngineers.length > 0
        ? workingEngineers.map(e => `<div class="engineer-item" data-engineer="${e}">${e}</div>`).join('')
        : '<div class="no-jobs">No engineers working</div>';

    engineersList.querySelectorAll('.engineer-item').forEach(item => {
        item.addEventListener('click', () => {
            selectedEngineer = selectedEngineer === item.dataset.engineer ? '' : item.dataset.engineer;
            document.getElementById('engineerFilter').value = selectedEngineer;
            populateEngineersListAndFilterJobs();
        });
        item.classList.toggle('selected', item.dataset.engineer === selectedEngineer);
    });

    displayJobs(jobsByEngineer);
    updateAssignJobsButton();
}

function filterJobs() {
    return allJobs.filter(job => {
        const jobDate = job.dateComponents;
        const jobEngineer = job.Engineer;
        
        const dateMatch = !selectedDate || (
            jobDate.day === selectedDate.day &&
            jobDate.month === selectedDate.month &&
            jobDate.year === selectedDate.year
        );
        
        const engineerMatch = !selectedEngineer || jobEngineer === selectedEngineer;
        
        return dateMatch && engineerMatch;
    });
}

function displayJobs(jobsByEngineer) {
    const jobsContainer = document.getElementById('engineerJobsContainer');
    jobsContainer.innerHTML = '';

    if (jobsByEngineer.size === 0) {
        jobsContainer.innerHTML = '<div class="no-jobs">No jobs scheduled for this date.</div>';
    } else {
        jobsByEngineer.forEach((jobs, engineer) => {
            const amJobs = jobs.filter(job => job.Time?.toUpperCase().includes('AM'));
            const pmJobs = jobs.filter(job => job.Time?.toUpperCase().includes('PM'));
            
            const column = document.createElement('div');
            column.className = 'engineer-column';
            column.innerHTML = `
                <h3>${engineer}</h3>
                <div class="engineer-job-sections">
                    <div class="time-section">
                        <h4>Morning Jobs (AM)</h4>
                        <div class="jobs-container">
                            ${amJobs.length ? amJobs.map(createJobCard).join('') : '<div class="no-jobs">No AM jobs</div>'}
                        </div>
                    </div>
                    <div class="time-section">
                        <h4>Afternoon Jobs (PM)</h4>
                        <div class="jobs-container">
                            ${pmJobs.length ? pmJobs.map(createJobCard).join('') : '<div class="no-jobs">No PM jobs</div>'}
                        </div>
                    </div>
                </div>
            `;
            jobsContainer.appendChild(column);
        });
    }

    jobsContainer.querySelectorAll('.job-card').forEach(card => {
        card.addEventListener('click', handleJobCardClick);
    });
}

function createJobCard(job) {
    const statusClass = job.Status ? job.Status.toLowerCase().replace(' ', '-') : '';
    const statusDisplay = job.Status || 'Pending';
    
    return `
        <div class="job-card ${statusClass}" data-ref="${job.Ref}">
            <div class="job-header">
                <div class="job-ref">Job #${job.Ref}</div>
                <div class="job-status ${statusClass}">${statusDisplay}</div>
            </div>
            <div class="job-details">
                <div class="job-detail"><strong>Customer:</strong> ${job['Appointment Contact Name'] || 'N/A'}</div>
                <div class="job-detail"><strong>Phone:</strong> ${job['Appointment Contact Number'] || 'N/A'}</div>
                <div class="job-detail"><strong>Address:</strong> ${job.Address || 'N/A'}</div>
                <div class="job-detail"><strong>Postcode:</strong> ${job['Job Details : Postcode'] || 'N/A'}</div>
                <div class="job-detail"><strong>Time:</strong> ${job.Time || 'N/A'}</div>
                <div class="job-detail"><strong>Date:</strong> ${job.displayDate}</div>
                <div class="job-detail"><strong>Engineer:</strong> ${job.Engineer || 'Unassigned'}</div>
            </div>
        </div>
    `;
}

function handleJobCardClick(e) {
    e.stopPropagation();
    currentJobCard = e.currentTarget;
    currentJobRef = currentJobCard.dataset.ref;
    
    const rect = currentJobCard.getBoundingClientRect();
    const statusMenu = document.getElementById('statusMenu');
    statusMenu.style.display = 'block';
    statusMenu.style.left = rect.left + 'px';
    statusMenu.style.top = (rect.bottom + 5) + 'px';
    
    statusMenu.querySelectorAll('.status-option').forEach(option => {
        option.onclick = () => handleMenuOptionClick(option);
    });
}

function handleMenuOptionClick(option) {
    const action = option.dataset.action;
    document.getElementById('statusMenu').style.display = 'none';
    if (!currentJobRef) return;

    if (action === 'status') updateJobStatus(option.dataset.status);
    else if (action === 'engineer') openModal('engineer');
    else if (action === 'date') openModal('date');
}

function openModal(type) {
    const job = allJobs.find(j => j.Ref == currentJobRef);
    if (!job) return;

    modalTitle.textContent = `Update Job #${currentJobRef}`;
    updateModal.dataset.updateType = type;

    if (type === 'engineer') {
        engineerField.style.display = 'block';
        dateField.style.display = 'none';
        populateModalEngineerSelect(job.Engineer);
    } else if (type === 'date') {
        engineerField.style.display = 'none';
        dateField.style.display = 'block';
        const { year, month, day } = job.dateComponents;
        modalDateInput.value = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    }

    updateModal.style.display = 'block';
}

function closeModal() {
    updateModal.style.display = 'none';
    currentJobCard = null;
    currentJobRef = null;
}

function populateModalEngineerSelect(currentEngineer) {
    modalEngineerSelect.innerHTML = '';
    const unassigned = document.createElement('option');
    unassigned.value = 'Unassigned';
    unassigned.textContent = 'Unassigned';
    modalEngineerSelect.appendChild(unassigned);
    if (!currentEngineer || currentEngineer === 'Unassigned') unassigned.selected = true;

    allEngineers.forEach(eng => {
        const opt = document.createElement('option');
        opt.value = eng;
        opt.textContent = eng;
        if (eng === currentEngineer && currentEngineer !== 'Unassigned') opt.selected = true;
        modalEngineerSelect.appendChild(opt);
    });
}

async function saveChanges() {
    const type = updateModal.dataset.updateType;
    let newValue, apiField, clientField;
    const jobRef = currentJobRef;

    if (!jobRef) return alert('Error: No job selected.');

    if (type === 'engineer') {
        newValue = modalEngineerSelect.value;
        apiField = clientField = 'Engineer';
        if (!newValue) return alert('Please select an engineer.');
    } else if (type === 'date') {
        newValue = modalDateInput.value;
        apiField = clientField = 'Date';
        if (!newValue) return alert('Please select a date.');
    } else return;

    closeModal();
    await updateJobField(jobRef, apiField, newValue, clientField);
}

async function updateJobField(jobRef, apiField, newValue, clientField) {
    try {
        const payload = { action: "updateJob", data: { Ref: jobRef, [apiField]: newValue } };
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        });
        const result = JSON.parse(await response.text());

        if (result.success) {
            const job = allJobs.find(j => j.Ref == jobRef);
            if (job) {
                if (clientField === 'Date') {
                    const [y, m, d] = newValue.split('-');
                    job.Day = +d; job.Month = +m; job.Year = +y;
                    job.dateComponents = { day: +d, month: +m, year: +y };
                    job.displayDate = `${d}/${m}/${y}`;
                    if (selectedDate && (job.dateComponents.day !== selectedDate.day || job.dateComponents.month !== selectedDate.month || job.dateComponents.year !== selectedDate.year)) {
                        document.getElementById('dateFilter').value = newValue;
                        handleDateChange({ target: { value: newValue } });
                        return;
                    }
                } else {
                    job[clientField] = newValue;
                }
            }
            populateEngineersListAndFilterJobs();
            alert(`Job #${jobRef} updated to: ${newValue}`);
            if (assignJobsModal.style.display === 'block') populateUnassignedJobs();
        } else {
            throw new Error(result.message || 'Update failed');
        }
    } catch (error) {
        console.error('Update error:', error);
        alert(`Failed to update: ${error.message}`);
        await loadJobs(true);
    }
}

async function updateJobStatus(newStatus) {
    await updateJobField(currentJobRef, 'Status', newStatus, 'Status');
}

function handleDateChange(e) {
    const val = e.target.value;
    if (val) {
        const [y, m, d] = val.split('-');
        selectedDate = { day: +d, month: +m, year: +y };
    } else {
        selectedDate = '';
    }
    populateEngineersListAndFilterJobs();
}

function handleEngineerChange(e) {
    selectedEngineer = e.target.value;
    populateEngineersListAndFilterJobs();
}

// === ASSIGN JOBS MODAL (ALL DATES) ===

function updateAssignJobsButton() {
    const unassignedCount = allJobs.filter(job => 
        job['Appointment Contact Name'] && !job.Engineer
    ).length;
    const btn = document.getElementById('assignJobsBtn');
    btn.textContent = `Assign Jobs (${unassignedCount})`;
    btn.disabled = unassignedCount === 0;
}

function openAssignJobsModal() {
    assignJobsModal.style.display = 'block';
    populateUnassignedJobs();
}

function closeAssignJobsModal() {
    assignJobsModal.style.display = 'none';
}

function populateUnassignedJobs() {
    const unassignedJobs = allJobs.filter(job => 
        job['Appointment Contact Name'] && !job.Engineer
    );

    const jobCountByEngineerAndDate = {};
    allJobs.forEach(job => {
        if (job.Engineer && job.dateComponents.day) {
            const key = `${job.Engineer}|${job.dateComponents.year}-${String(job.dateComponents.month).padStart(2,'0')}-${String(job.dateComponents.day).padStart(2,'0')}`;
            jobCountByEngineerAndDate[key] = (jobCountByEngineerAndDate[key] || 0) + 1;
        }
    });

    const list = document.getElementById('unassignedJobsList');
    if (unassignedJobs.length === 0) {
        list.innerHTML = '<div class="no-jobs">No unassigned jobs found.</div>';
        return;
    }

    list.innerHTML = unassignedJobs.map(job => {
        const jobDateKey = `${job.dateComponents.year}-${String(job.dateComponents.month).padStart(2,'0')}-${String(job.dateComponents.day).padStart(2,'0')}`;
        const options = allEngineers.map(eng => {
            const count = jobCountByEngineerAndDate[`${eng}|${jobDateKey}`] || 0;
            return `<option value="${eng}">${eng} (${count} jobs that day)</option>`;
        }).join('');

        return `
            <div class="job-card unassigned" data-ref="${job.Ref}">
                <div class="job-header">
                    <div class="job-ref">Job #${job.Ref}</div>
                    <div class="job-status unassigned">Unassigned</div>
                </div>
                <div class="job-details">
                    <div class="job-detail"><strong>Date:</strong> ${job.displayDate}</div>
                    <div class="job-detail"><strong>Contact:</strong> ${job['Appointment Contact Name']}</div>
                    <div class="job-detail"><strong>Site:</strong> ${job.Site || 'N/A'}</div>
                    <div class="job-detail"><strong>Address:</strong> ${job.Address}</div>
                    <div class="job-detail"><strong>Postcode:</strong> ${job['Job Details : Postcode']}</div>
                    <div class="job-detail"><strong>Time Slot:</strong> ${job.Time}</div>
                </div>
                <select onchange="assignEngineerToJob('${job.Ref}', this.value)">
                    <option value="">Select Engineer</option>
                    ${options}
                </select>
            </div>
        `;
    }).join('');
}

function assignEngineerToJob(ref, engineer) {
    if (!engineer) return;
    updateJobField(ref, 'Engineer', engineer, 'Engineer');
}

// === ADD APPOINTMENT / ENGINEER (unchanged) ===

function openAddAppointmentModal() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('newDate').value = today;
    document.getElementById('addAppointmentForm').reset();
    document.getElementById('newDate').value = today;
    populateNewEngineerSelect();
    addAppointmentModal.style.display = 'block';
}

function closeAddAppointmentModal() {
    addAppointmentModal.style.display = 'none';
    document.getElementById('addAppointmentForm').reset();
}

async function submitNewAppointment() {
    const fields = ['newContactName','newContactNumber','newAddress','newPostcode','newDate','newTime','newEngineer'];
    const values = fields.map(id => document.getElementById(id).value.trim());
    if (values.slice(0, -1).some(v => !v)) return alert('Please fill all required fields.');

    const [contactName, contactNumber, , site, address, postcode, date, time, engineer] = values;
    const appointmentData = { ContactName: contactName, ContactNumber: contactNumber, Site: site, Address: address, Postcode: postcode, Date: date, Time: time, Engineer: engineer };

    try {
        const payload = { action: "addJob", data: appointmentData };
        const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
        const result = JSON.parse(await res.text());
        if (result.success) {
            alert(`Appointment added! Ref: ${result.ref}`);
            closeAddAppointmentModal();
            await loadJobs(true);
        } else throw new Error(result.message);
    } catch (err) {
        alert(`Failed: ${err.message}`);
    }
}

function openAddEngineerModal() {
    document.getElementById('addEngineerForm').reset();
    addEngineerModal.style.display = 'block';
}

function closeAddEngineerModal() {
    addEngineerModal.style.display = 'none';
}

async function submitNewEngineer() {
    const name = document.getElementById('engineerName').value.trim();
    const password = document.getElementById('engineerPassword').value.trim();
    const phone = document.getElementById('engineerPhone').value.trim();
    const location = document.getElementById('engineerLocation').value;
    if (![name, password, phone, location].every(Boolean)) return alert('All fields required.');

    const payload = { action: "addEngineer", data: { Name: name, Password: password, PhoneNumber: phone, Location: location } };
    try {
        const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
        const result = JSON.parse(await res.text());
        if (result.success) {
            alert(`Engineer ${name} added!`);
            closeAddEngineerModal();
            await loadJobs(true);
        } else throw new Error(result.message);
    } catch (err) {
        alert(`Failed: ${err.message}`);
    }
}

/* ================== MAP VIEW ================== */

function openMapModal() {
    document.getElementById('mapModal').style.display = 'block';
    document.getElementById('mapDateSelect').value = document.getElementById('dateFilter').value;
    document.getElementById('mapEngineerSelect').value = selectedEngineer;

    if (!map) {
        map = L.map('mapContainer').setView([54.5, -4], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    }

    updateMapView();
}

async function updateMapView() {
    const selectedEng = document.getElementById('mapEngineerSelect').value;
    const dateVal = document.getElementById('mapDateSelect').value;
    if (!dateVal) return alert('Please select a date.');

    const [y, m, d] = dateVal.split('-');
    const targetDate = { day: +d, month: +m, year: +y };

    const jobs = allJobs.filter(j => {
        const dateOk = j.dateComponents.day === targetDate.day &&
                      j.dateComponents.month === targetDate.month &&
                      j.dateComponents.year === targetDate.year;
        const engOk = !selectedEng || j.Engineer === selectedEng;
        return dateOk && engOk && j['Job Details : Postcode'];
    });

    // Clear old markers
    mapMarkers.forEach(m => map.removeLayer(m));
    mapMarkers = [];
    if (mapPolyline) { map.removeLayer(mapPolyline); mapPolyline = null; }

    if (jobs.length === 0) {
        alert('No jobs with postcode found.');
        return;
    }

    const coords = [];
    for (const job of jobs) {
        const pc = job['Job Details : Postcode'].trim();
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(pc)}&format=json&limit=1`);
            const data = await res.json();
            if (data && data[0]) {
                const lat = parseFloat(data[0].lat);
                const lng = parseFloat(data[0].lon);
                const marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`
                    <b>Job #${job.Ref}</b><br>
                    ${job['Appointment Contact Name']}<br>
                    ${job.Address}<br>
                    <b>Postcode:</b> ${pc}<br>
                    <b>Time:</b> ${job.Time || 'N/A'}<br>
                    <b>Engineer:</b> ${job.Engineer || 'Unassigned'}
                `);
                mapMarkers.push(marker);
                coords.push([lat, lng]);
            }
        } catch (e) {
            console.error('Geocode failed:', pc, e);
        }
    }

    if (coords.length > 0) {
        map.fitBounds(L.latLngBounds(coords).pad(0.2));
        if (coords.length > 1) {
            mapPolyline = L.polyline(coords, { color: '#667eea', weight: 4, opacity: 0.7 }).addTo(map);
        }
    }
}

function closeMapModal() {
    document.getElementById('mapModal').style.display = 'none';
}

window.addEventListener('load', init);
</script>
</body>
</html>
